---
title: "Project"
author: "Dylan Berneman"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE)
install.packages('astsa')
install.packages('tseries')
install.packages('basicTrendline')
install.packages("nortsTest")
install.packages("nortest")
install.packages('distributional')
install.packages("TSA")
install.packages("AICcmodavg")
install.packages('FinTS')
install.packages('FitAR')
install.packages("forecast")
install.packages("Dict")
install.packages('ggplot2')
install.packages("ggfortify")
install.packages('latex2exp')
install.packages('polynom')
install.packages('sarima')
install.packages("MuMIn")
# devtools::install_github("FinYang/tsdl")
library(devtools)
library(tseries)
library(Dict)
library(backports)
library(nortsTest)
library(nortest)
library(TSA)
library(MuMIn)
library(astsa)
library(basicTrendline)
# library(tsdl)
library(dplyr)
library(FinTS)
library(FitAR)
library(forecast)
library(ggplot2)
library(latex2exp)
library(ggfortify)
library(MASS)
library(polynom)
library(readr)
library(readxl)
library(sarima)
library(tinytex)

```
\

We will be testing the datasets corresponding to:\
  - The smoothed amount of daily new COVID cases (Cases)
  - The smoothed amount of daily new deaths from COVID (Deathss)
  - The daily mortality rate of those who contract COVID (Mortality)
  - The daily percent of the world that has been vaccinated (Vaccinated)\
\

For each data set, the length of the time series will be evaluated in at most 3 ways:\
  - [January 8, 2020 - May 24, 2023]
    - Cases will begin on the 6th observation day, January 8, 2020, since there were some observations of 0 new cases before then
  - [January 12, 2020 - May 24, 2023]
    - Deaths and Mortality will begin on the 10th observation day, January 12, 2020, since that was the time of the first death
  - [January 8, 2020 - December 3, 2020]
    - This will account for all daily observations of Cases before the first person got vaccinated
  - [January 12, 2020 - December 3, 2020]
    - This will account for all daily observations for Deaths and Mortality before the first person got vaccinated
  - [December 4, 2020 - May 24, 2023]
    - This will account for all daily observations for Cases, Deaths, Mortality, and Vaccinated since the first person got vaccinated.\
\

Additionally, since daily observations can be very noisy, we will also be testing the weekly average for each of the previously mentioned time series. In total, that will be 20 data sets.\
\

In regards to the names of the data sets:\
  - '1' refers to the entire pandemic
  - '2' refers to the time before the first vaccination
  - '3' refers to the time since the first vaccination
  - 'a' denotes daily observations
  - 'b' denotes average weekly observations\
\

# Original Datasets
```{r}
options(scipen = 9)
covid <- read_excel("World_Covid.xlsx")


# Cases: [January 8, 2020 - May 24, 2023]
  # Daily
Cases1a = ts(covid$new_cases_smoothed[6:1238])
Cases1a= data.frame(Cases1a)
  # Weekly
Cases1b=vector()
for(i in 1:176){
  x = 7 * (i-1) + 1
  y = 7 * i
  Cases1b <- append(Cases1b, mean(Cases1a[x:y, 1]))
  Cases1b = ts(Cases1b)}
Cases1b = data.frame(Cases1b)


# Deaths: [January 12, 2020 - May 24, 2023]
  # Daily
Deaths1a = ts(covid$new_deaths_smoothed[10:1238])
Deaths1a= data.frame(Deaths1a)
  # Weekly
Deaths1b=vector()
for(i in 1:175){
  x = 7 * (i-1) + 1
  y = 7 * i
  Deaths1b <- append(Deaths1b, mean(Deaths1a[x:y, 1]))
  Deaths1b = ts(Deaths1b)}
Deaths1b = data.frame(Deaths1b)


# Mortality: [January 12, 2020 - May 24, 2023]
  # Daily
Mort1a = ts(covid$Mortality[10:1238])
Mort1a= data.frame(Mort1a)
  # Weekly
Mort1b=vector()
for(i in 1:175){
  x = 7 * (i-1) + 1
  y = 7 * i
  Mort1b <- append(Mort1b, mean(Mort1a[x:y, 1]))
  Mort1b = ts(Mort1b)}
Mort1b = data.frame(Mort1b)


# Cases: [January 8, 2020 - December 3, 2020]
  # Daily
Cases2a = ts(covid$new_cases_smoothed[6:336])
Cases2a= data.frame(Cases2a)
  # Weekly
Cases2b=vector()
for(i in 1:47){
  x = 7 * (i-1) + 1
  y = 7 * i
  Cases2b <- append(Cases2b, mean(Cases2a[x:y, 1]))
  Cases2b = ts(Cases2b)}
Cases2b = data.frame(Cases2b)


# Deaths: [January 12, 2020 - December 3, 2020]
  # Daily
Deaths2a = ts(covid$new_deaths_smoothed[10:336])
Deaths2a= data.frame(Deaths2a)
  # Weekly
Deaths2b=vector()
for(i in 1:46){
  x = 7 * (i-1) + 1
  y = 7 * i
  Deaths2b <- append(Deaths2b, mean(Deaths2a[x:y, 1]))
  Deaths2b = ts(Deaths2b)}
Deaths2b = data.frame(Deaths2b)


# Mortality: [January 12, 2020 - December 3, 2020]
  # Daily
Mort2a = ts(covid$Mortality[10:336])
Mort2a= data.frame(Mort2a)
  # Weekly
Mort2b=vector()
for(i in 1:46){
  x = 7 * (i-1) + 1
  y = 7 * i
  Mort2b <- append(Mort2b, mean(Mort2a[x:y, 1]))
  Mort2b = ts(Mort2b)}
Mort2b = data.frame(Mort2b)


# Cases: [December 4, 2020 - May 24, 2023]
  # Daily
Cases3a = ts(covid$new_cases_smoothed[337:1238])
Cases3a= data.frame(Cases3a)
  # Weekly
Cases3b=vector()
for(i in 1:128){
  x = 7 * (i-1) + 1
  y = 7 * i
  Cases3b <- append(Cases3b, mean(Cases3a[x:y, 1]))
  Cases3b = ts(Cases3b)}
Cases3b = data.frame(Cases3b)


# Deaths: [December 4, 2020 - May 24, 2023]
  # Daily
Deaths3a = ts(covid$new_deaths_smoothed[337:1238])
Deaths3a= data.frame(Deaths3a)
  # Weekly
Deaths3b=vector()
for(i in 1:128){
  x = 7 * (i-1) + 1
  y = 7 * i
  Deaths3b <- append(Deaths3b, mean(Deaths3a[x:y, 1]))
  Deaths3b = ts(Deaths3b)}
Deaths3b = data.frame(Deaths3b)


# Mortality: [December 4, 2020 - May 24, 2023]
  # Daily
Mort3a = ts(covid$Mortality[337:1238])
Mort3a= data.frame(Mort3a)
  # Weekly
Mort3b=vector()
for(i in 1:128){
  x = 7 * (i-1) + 1
  y = 7 * i
  Mort3b <- append(Mort3b, mean(Mort3a[x:y, 1]))
  Mort3b = ts(Mort3b)}
Mort3b = data.frame(Mort3b)


# Vax: [December 4, 2020 - May 24, 2023]
  # Daily
Vax3a = ts(covid$people_vaccinated[337:1238])
Vax3a= data.frame(Vax3a)
  # Weekly
Vax3b=vector()
for(i in 1:128){
  x = 7 * (i-1) + 1
  y = 7 * i
  Vax3b <- append(Vax3b, mean(Vax3a[x:y, 1]))
  Vax3b = ts(Vax3b)}
Vax3b = data.frame(Vax3b)


vect = vector()
vect = append(vect, Cases1a)
vect = append(vect, Cases1b)
vect = append(vect, Deaths1a)
vect = append(vect, Deaths1b)
vect = append(vect, Mort1a)
vect = append(vect, Mort1b)
vect = append(vect, Cases2a)
vect = append(vect, Cases2b)
vect = append(vect, Deaths2a)
vect = append(vect, Deaths2b)
vect = append(vect, Mort2a)
vect = append(vect, Mort2b)
vect = append(vect, Cases3a)
vect = append(vect, Cases3b)
vect = append(vect, Deaths3a)
vect = append(vect, Deaths3b)
vect = append(vect, Mort3a)
vect = append(vect, Mort3b)
vect = append(vect, Vax3a)
vect = append(vect, Vax3b)

vect1 = vector()
vect1 = append(vect1, "Cases1a")
vect1 = append(vect1, "Cases1b")
vect1 = append(vect1, "Deaths1a")
vect1 = append(vect1, "Deaths1b")
vect1 = append(vect1, "Mort1a")
vect1 = append(vect1, "Mort1b")
vect1 = append(vect1, "Cases2a")
vect1 = append(vect1, "Cases2b")
vect1 = append(vect1, "Deaths2a")
vect1 = append(vect1, "Deaths2b")
vect1 = append(vect1, "Mort2a")
vect1 = append(vect1, "Mort2b")
vect1 = append(vect1, "Cases3a")
vect1 = append(vect1, "Cases3b")
vect1 = append(vect1, "Deaths3a")
vect1 = append(vect1, "Deaths3b")
vect1 = append(vect1, "Mort3a")
vect1 = append(vect1, "Mort3b")
vect1 = append(vect1, "Vax3a")
vect1 = append(vect1, "Vax3b")
```
\

# Transformation, Differencing, Normality Tests, and Stationarity Tests
# V2
```{r, warning = FALSE}

# We will create 3 transformations of each model:
#   - Box-Cox Transformation
#   - Log Transformation
#   - Square Root Transformation

`_` = list()
bc = list()
log = list()
sqrt = list()
Data_a <- data.frame(matrix(ncol=23, nrow=480))
colnames(Data_a) <- c("Name", "Dataset", "Average", "Transformation", "Differencing", 
                    "Anderson-Darling Test", "Shapiro test", 
                    "Augmented Dickey-Fuller Test", "KPSS Test", "Box-Pierce Test", 
                    "Ljung-Box Test", "McLeod-Li Test", "Grandparent_Variance", 
                    "Parent_Variance", "Nonseasonal_Variance", "Seasonal_Variance", 
                    "Variance", "Variance_test", "AICc", "Residual_Tests", 
                    "Normality_Tests", "Stationarity_Tests", "X")

# For tests, reject if p < 0.05
ad_test_a = list()    # H_0 = data is normally distributed (do not want to reject)
shapiro_test_a = list()   # H_0 = data is normal (do not want to reject)
kpss_test_a = list()    # H_0 = data is stationary (do not want to reject)
adf_test_a = list()       # H_0 = data contains a unit root and are non stationary (want to reject)
Box_Pierce_test_a = list()  # H_0 = data are white noise (do not want to reject)
Ljung_Box_test_a = list()   # H_0 = Residuals are not autocorrelated / the data are independently distributed (do not want to reject)
McLeod_Li_test_a = list()   # H_0 = Independence of residuals (do not want to reject)

# Rejecting a test has a greater significance than not rejecting a test. This is because rejection proves that the null hypothesis cannot be true while not rejecting implies that nothing was found that proves the null hypothesis false. Just because a test doesn't have a reason to reject the null hypothesis does not mean that there exists no reason to reject it. It only means that particular test could not prove the null hypothesis false. A similar test for the same null or alternative hypothesis can have a different result. The test that rejects its null hypothesis is therefore given more weight to its validity.

# Since the kpss.test and adf.test have opposing null hypotheses for the stationarity of a time series, we will put more double weight on the adf.test being rejected when calulating the amount of tests that give a favorable result.
transformation_name1 = vector()
Difference1 = vector()
Best_Models_a = list()
Best_Models_a1 = list()

x = 1
for(i in 1:length(vect)){
  bcTransform <- boxcox(vect[[i]]~ as.numeric(1:length(vect[[i]])))       # plot the graph

  bcTransform$x[which(bcTransform$y == max(bcTransform$y))] # gives the value of λ
  lambda=bcTransform$x[which(bcTransform$y == max(bcTransform$y))]
  title(main = paste0(vect1[i], "  lambda = ", round(lambda, 3)))
  
  # Perform transformations, plot transformed data, histograms:
  assign(paste0(vect1[i], "1"),  data.frame(vect[[i]]))
  assign(paste0(vect1[i], ".bc1"),  data.frame((1/lambda)*(vect[[i]]^lambda-1)))
  assign(paste0(vect1[i], ".log1"),  data.frame(log(vect[[i]])))
  assign(paste0(vect1[i], ".sqrt1"), data.frame(sqrt(vect[[i]])))
  
  transform = vector()
  transform = append(transform, get(paste0(vect1[i], "1")))
  transform = append(transform, get(paste0(vect1[i], ".bc1")))
  transform = append(transform, get(paste0(vect1[i], ".log1")))
  transform = append(transform, get(paste0(vect1[i], ".sqrt1")))

  transform_name = vector()
  transform_name = append(transform_name, paste0(vect1[i], "1"))
  `_` = append(`_`, vect1[i])
  transform_name = append(transform_name, paste0(vect1[i], ".bc1"))
  bc = append(bc, paste0(vect1[i], ".bc1"))
  transform_name = append(transform_name, paste0(vect1[i], ".log1"))
  log = append(log, paste0(vect1[i], ".log1"))
  transform_name = append(transform_name, paste0(vect1[i], ".sqrt1"))
  sqrt = append(sqrt, paste0(vect1[i], ".sqrt1"))
  
  transformation_name1 = append(transformation_name1, transform_name)
  
# For each of the 3 transformations and the original for each data set, 
# we will test the goodness of fit when each time series is differenced at: 
#   - Lag 0 (no differencing) 
#   - Lag 1 (non seasonal difference - yearly)
#   - Lag 7 (seasonal difference - weekly) 
#   - Lag 12 (seasonal difference - monthly) 
#   - Lag 1.7 (non seasonal difference - yearly & seasonal difference - weekly) 
#   - Lag 1.12 (non seasonal difference - yearly & seasonal difference - monthly) 

# This bring the total number of models being evaluated to 480.
  
  list = c(0,1,7,12,1.7,1.12)
  for(j in 1:length(transform)){
    difference = vector()
    diff_name = vector()
    for(k in 1:length(list)){
      Data_a$X[x] = x
      Data_a$Grandparent_Variance[x] = signif(var(vect[[i]]), 4)
      Data_a$Parent_Variance[x] = signif(var(transform[[j]]), 4)
      Data_a$Dataset[x] = vect1[i]
      if(transform_name[j] %in% `_`){
        Data_a$Transformation[x] = "none"}
      if(transform_name[j] %in% bc){
        Data_a$Transformation[x] = "Box-Cox"}
      if(transform_name[j] %in% log){
        Data_a$Transformation[x] = "Log"}
      if(transform_name[j] %in% sqrt){
        Data_a$Transformation[x] = "Square Root"}
      if(i%%2 == 0){
        Data_a$Average[x] = "Weekly"}
      if(i%%2 == 1){
        Data_a$Average[x] = "Daily"}
      
      diff_name = append(diff_name, paste0(transform_name[j], "(", list[k], ")"))

      if(list[k]==0){
        Data_a[x,1] = diff_name[k]
        Data_a$Differencing[x] = "Lag = none"
        diff = try(arima(transform[[j]], order = c(0,0,0), method = "ML"))
        difference = append(difference, data.frame(transform[[j]]))
        Data_a$AICc[x] = try(AICc(diff))
        Data_a$Variance[x] = Data_a$Parent_Variance[x]
        Data_a$Nonseasonal_Variance[x] = Data_a$Variance[x]
        Data_a$Seasonal_Variance[x] = Data_a$Variance[x]}
      if(list[k]==1 | list[k]==7 | list[k]==12){
        Data_a[x,1] = paste0(transform_name[j], "(", list[k], ")")
        diff = diff(transform[[j]], lag = list[k])
        difference = append(difference, data.frame(diff))
        res = try(arima(diff, order = c(0,0,0), method="ML"))
        Data_a$AICc[x] = try(AICc(res), silent = TRUE)
        Data_a$Differencing[x] = paste0("Lag = ", list[k])
        Data_a$Variance[x] = signif(var(diff), 4)
        Data_a$Nonseasonal_Variance[x] = Data_a$Variance[x]
        Data_a$Seasonal_Variance[x] = Data_a$Variance[x]}
      if(list[k]==1.7 | list[k]==1.12){
        Data_a[x,1] = paste0(transform_name[j], "(", list[k], ")")
        diff1 = diff(transform[[j]], lag = 1)
        diff = diff(diff1, lag = list[k-2])
        difference = append(difference, data.frame(diff))
        res = try(arima(diff, order = c(0,0,0), method="ML"))
        Data_a$AICc[x] = try(AICc(res), silent = TRUE)
        Data_a$Differencing[x] = paste0("Lag = 1 & Lag = ", list[k-2])
        Data_a$Variance[x] = signif(var(diff),4)
        Data_a$Seasonal_Variance[x] = Data_a$Variance[x-2]
        if(list[k]==1.7){
          Data_a$Nonseasonal_Variance[x] = Data_a$Nonseasonal_Variance[x-3]}
        if(list[k]==1.12){
          Data_a$Nonseasonal_Variance[x] = Data_a$Nonseasonal_Variance[x-4]}}
      if(list[k]==1.12){
        assign(paste0("diff_", transform_name[j]), difference)
        Difference1 = append(Difference1, get(paste0("diff_", transform_name[j])))
        assign(paste0("diff_name_", transform_name[j]), diff_name)}
      
      
      Data_a[x, 6] = round(ad.test(difference[[k]])$p.value, digits=5)
      
      Data_a[x, 7] = round(shapiro.test(difference[[k]])$p.value, digits=5)
      
      Data_a[x, 8] = round(adf.test(difference[[k]])$p.value, digits=5)
      
      Data_a[x, 9] = round(kpss.test(difference[[k]])$p.value, digits=5)
      
      Data_a[x, 10] = round(Box.test(difference[[k]], lag=sqrt(length(
        difference[[k]])), type=c("Box-Pierce"), fitdf = 0)$p.value, digits=5)
      
      Data_a[x, 11] = round(Box.test(difference[[k]], lag=sqrt(length(
        difference[[k]])), type=c("Ljung-Box"), fitdf = 0)$p.value, digits=5)
      
      Data_a[x, 12] = round(Box.test((difference[[k]])^2, lag=sqrt(length(
        difference[[k]])), type=c("Ljung-Box"), fitdf = 0)$p.value, digits=5)
      
      Data_a$Pass[x]=0
      for(z in c(6,7, 9:12)){
        if(Data_a[x,z]>=0.05){
          Data_a$Pass[x] = 1 + Data_a$Pass[x]}}
      if(Data_a[x, 8] <= 0.05){
        Data_a$Pass[x] = 2 + Data_a$Pass[x]}
      Variance_Order = data.frame(matrix(ncol=3, nrow=5))
      colnames(Variance_Order) = c("Levels", "Variance", "Rank")
      Variance_Order$Levels = c("Original", "Transformation", "Differencing", 
                                "Seasonality", "Current")
      Variance_Order$Variance[1:5] = Data_a[x, c(13:17)]
      Variance_Order$Variance = as.double(Variance_Order$Variance)
      Variance_Order$Rank = as.integer(rank(Variance_Order$Variance, ties.method = "min"))
      Data_a$Variance_test[x] = paste0(
        Variance_Order$Rank[1], ", ", Variance_Order$Rank[2],
        ", ", Variance_Order$Rank[3], ", ", Variance_Order$Rank[4], ", ", 
        Variance_Order$Rank[5])
      Fails = 0
      if(Data_a[x, 13] < Data_a[x, 14]){
        Fails=Fails+1}
      if((Data_a[x, 14] < Data_a[x, 15]) & (Data_a[x, 14] < Data_a[x, 16])){
        Fails=Fails+1}
      if((Data_a[x, 13] < Data_a[x, 15]) & (Data_a[x, 13] < Data_a[x, 16])){
        Fails=Fails+1}
      if((Data_a[x, 15] < Data_a[x, 17]) & (Data_a[x, 16] < Data_a[x, 17])){
        Fails=Fails+1}
      if(Data_a[x, 13] < Data_a[x, 17]){
        Fails=Fails+1}
      if(Data_a[x, 14] < Data_a[x, 17]){
        Fails=Fails+1}
      Data_a$Pass[x] = (6-Fails)/6 + Data_a$Pass[x]
      if(Data_a$Pass[x] >= 6){
        # None of the undifferenced transformations for each data set are part of the best models
        if(list(k)==0){
          list1 = list("ARIMA(0,0,0)", x, i, transform_name[j])
          Best_Models_a1 = append(Best_Models_a1, list1)
          Best_Models_a = append(Best_Models_a, difference[k])}
        if(list[k]==1){
          list1 = list("ARIMA(0,1,0)", x, i, transform_name[j])
          Best_Models_a1 = append(Best_Models_a1, list1)
          Best_Models_a = append(Best_Models_a, difference[k])}
        if(list[k]==7){
          list1 = list("ARIMA(0,7,0)", x, i, transform_name[j])
          Best_Models_a1 = append(Best_Models_a1, list1)
          Best_Models_a = append(Best_Models_a, difference[k])}
        if(list[k]==12){
          list1 = list("ARIMA(0,12,0)", x, i, transform_name[j])
          Best_Models_a1 = append(Best_Models_a1, list1)
          Best_Models_a = append(Best_Models_a, difference[k])}
        if(list[k]==1.7){
          list1 = list("SARIMA(0,1,0)x(0,1,0)_7", x, i, transform_name[j])
          Best_Models_a1 = append(Best_Models_a1, list1)
          Best_Models_a = append(Best_Models_a, difference[k])}
        if(list[k]==1.12){
          list1 = list("SARIMA(0,1,0)x(0,1,0)_12", x, i, transform_name[j])
          Best_Models_a1 = append(Best_Models_a1, list1)
          Best_Models_a = append(Best_Models_a, difference[k])}}
      Pass1 = 0 
      for(s in 10:12){
        if(Data_a[x,s] >= 0.05){
          Pass1 = Pass1 + 1}}
      if(Pass1 == 3){
        Data_a$Residual_Tests[x] = "Pass"}
      else{
        Data_a$Residual_Tests[x] = "Fail"}
      Pass2 = 0
      if(Data_a[x,6] >= 0.05){
        Pass2 = Pass2 + 1}
      if(Data_a[x,7] >= 0.05){
        Pass2 = Pass2 + 1}
      if(Pass2 >= 1){
        Data_a$Normality_Tests[x] = "Pass"}
      else{
        Data_a$Normality_Tests[x] = "Fail"}
      Pass3 = 0
      if(Data_a[x,9] >= 0.05){
        Pass3 = Pass3 + 1}
      if(Data_a[x,8] <= 0.05){
        Pass3 = Pass3 + 1}
      if(Pass3 >= 1){
        Data_a$Stationarity_Tests[x] = "Pass"}
      else{
        Data_a$Stationarity_Tests[x] = "Fail"}
      x = x + 1}}}

Dict1 = dict(init_keys = NULL, init_values = NULL)
for(i in 1:480){
  Dict1[Data_a$Name[i]] = Difference1[[i]]}

Data_a["Dict"] = 2

Data_a1 = subset(Data_a, Data_a$Pass >= 4)
Data_a1

Stationarity_a = subset(Data_a, Data_a$Stationarity_Tests == "Pass")
Stationarity_a
Normality_a = subset(Data_a, Data_a$Normality_Tests == "Pass")
Normality_a
Residuals_a = subset(Data_a, Data_a$Residual_Tests == "Pass")
Residuals_a


Stat_Norm = subset(Stationarity_a, Stationarity_a$Normality_Tests == "Pass")
Stat_Norm_Pass = subset(Stat_Norm, Stat_Norm$Pass >=4)
Stat_Res = subset(Stationarity_a, Stationarity_a$Residual_Tests == "Pass")
Stat_Res_Pass = subset(Stat_Res, Stat_Res$Pass >=4)
Res_Norm = subset(Residuals_a, Residuals_a$Normality_Tests == "Pass")
```

# Transformation, Differencing, Normality Tests, and Stationarity Tests
# V1
```{r, warning = FALSE}

# We will create 3 transformations of each model:
#   - Box-Cox Transformation
#   - Log Transformation
#   - Square Root Transformation

`_` = list()
bc = list()
log = list()
sqrt = list()
Data <- data.frame(matrix(ncol=23, nrow=480))
colnames(Data) <- c("Name", "Dataset", "Average", "Transformation", "Differencing", 
                    "Anderson-Darling Test", "Shapiro test", 
                    "Augmented Dickey-Fuller Test", "KPSS Test", "Box-Pierce Test", 
                    "Ljung-Box Test", "McLeod-Li Test", "Grandparent_Variance", 
                    "Parent_Variance", "Nonseasonal_Variance", "Seasonal_Variance", 
                    "Variance", "Variance_test", "AICc", "Residual_Tests", 
                    "Normality_Tests", "Stationarity_Tests", "X") 

# For tests, reject if p < 0.05
ad_test = list()    # H_0 = data is normally distributed (do not want to reject)
shapiro_test = list()   # H_0 = data is normal (do not want to reject)
kpss_test = list()    # H_0 = data is stationary (do not want to reject)
adf_test = list()       # H_0 = data contains a unit root and are non stationary (want to reject)
Box_Pierce_test = list()  # H_0 = data are white noise (do not want to reject)
Ljung_Box_test = list()   # H_0 = Residuals are not autocorrelated / the data are independently distributed (do not want to reject)
McLeod_Li_test = list()   # H_0 = Independence of residuals (do not want to reject)

# Rejecting a test has a greater significance than not rejecting a test. This is because rejection proves that the null hypothesis cannot be true while not rejecting implies that nothing was found that proves the null hypothesis false. Just because a test doesn't have a reason to reject the null hypothesis does not mean that there exists no reason to reject it. It only means that particular test could not prove the null hypothesis false. A similar test for the same null or alternative hypothesis can have a different result. The test that rejects its null hypothesis is therefore given more weight to its validity.

# Since the kpss.test and adf.test have opposing null hypotheses for the stationarity of a time series, we will put more double weight on the adf.test being rejected when calulating the amount of tests that give a favorable result.
transformation_name = vector()
Best_Models = list()
Difference = vector()
x = 1
for(i in 1:length(vect)){
  bcTransform <- boxcox(vect[[i]]~ as.numeric(1:length(vect[[i]])))       # plot the graph

  bcTransform$x[which(bcTransform$y == max(bcTransform$y))] # gives the value of λ
  lambda=bcTransform$x[which(bcTransform$y == max(bcTransform$y))]
  title(main = paste0(vect1[i], "  lambda = ", round(lambda, 3)))
  
  # Perform transformations, plot transformed data, histograms:
  assign(paste0(vect1[i], ".bc"),  data.frame((1/lambda)*(vect[[i]]^lambda-1)))
  assign(paste0(vect1[i], ".log"),  data.frame(log(vect[[i]])))
  assign(paste0(vect1[i], ".sqrt"), data.frame(sqrt(vect[[i]])))
  
  transform = vector()
  transform = append(transform, data.frame(vect[[i]]))
  transform = append(transform, get(paste0(vect1[i], ".bc")))
  transform = append(transform, get(paste0(vect1[i], ".log")))
  transform = append(transform, get(paste0(vect1[i], ".sqrt")))

  transform_name = vector()
  transform_name = append(transform_name, vect1[i])
  `_` = append(`_`, vect1[i])
  transform_name = append(transform_name, paste0(vect1[i], ".bc"))
  bc = append(bc, paste0(vect1[i], ".bc"))
  transform_name = append(transform_name, paste0(vect1[i], ".log"))
  log = append(log, paste0(vect1[i], ".log"))
  transform_name = append(transform_name, paste0(vect1[i], ".sqrt"))
  sqrt = append(sqrt, paste0(vect1[i], ".sqrt"))
  
  transformation_name = append(transformation_name, transform_name)
  
# For each of the 3 transformations and the original for each data set, 
# we will test the goodness of fit when each time series is differenced at: 
#   - Lag 0 (no differencing) 
#   - Lag 1 (non seasonal difference - yearly)
#   - Lag 7 (seasonal difference - weekly) 
#   - Lag 12 (seasonal difference - monthly) 
#   - Lag 1.7 (non seasonal difference - yearly & seasonal difference - weekly) 
#   - Lag 1.12 (non seasonal difference - yearly & seasonal difference - monthly) 

# This bring the total number of models being evaluated to 480.
  
  list = c(0,1,7,12,1.7,1.12)
  for(j in 1:length(transform)){
    difference = vector()
    diff_name = vector()
    for(k in 1:length(list)){
      Data$X[x] = x
      Data$Grandparent_Variance[x] = signif(var(vect[[i]]), 4)
      Data$Parent_Variance[x] = signif(var(transform[[j]]), 4)
      Data$Dataset[x] = vect1[i]
      if(transform_name[j] %in% `_`){
        Data$Transformation[x] = "none"}
      if(transform_name[j] %in% bc){
        Data$Transformation[x] = "Box-Cox"}
      if(transform_name[j] %in% log){
        Data$Transformation[x] = "Log"}
      if(transform_name[j] %in% sqrt){
        Data$Transformation[x] = "Square Root"}
      if(i%%2 == 0){
        Data$Average[x] = "Weekly"}
      if(i%%2 == 1){
        Data$Average[x] = "Daily"}
      
      if(list[k]==0){
        diff_name = append(diff_name, paste0(transform_name[j], "(", list[k], ")"))
        Data[x,1] = transform_name[j]
        Data$Differencing[x] = "Lag = none, Period = none"
        difference = append(difference, transform[j])
        Data$AICc[x] = Data$Parent_Variance[x]
        Data$Variance[x] = signif(var(transform[[j]]), 4)
        Data$Nonseasonal_Variance[x] = Data$Variance[x]
        Data$Seasonal_Variance[x] = Data$Variance[x]}
      diff_name = append(diff_name, paste0(transform_name[j], "(", list[k], ")"))
      if(list[k]==1){
        diff_name = append(diff_name, paste0(transform_name[j], "(", list[k], ")"))
        assign(paste0(transform_name[j], "(", list[k], ")"),  arima(
          transform[[j]], order = c(0,1,0), method="ML")$residuals)
        AICc = arima(transform[[j]], order = c(0,1,0), method="ML")
        Data$AICc[x] = try(AICc(AICc), silent = TRUE)
        Data[x,1] = paste0(transform_name[j], "(", list[k], ")")
        Data$Differencing[x] = "Lag = 1, Period = none"
        difference = append(difference, data.frame(get(
          paste0(transform_name[j], "(", list[k], ")"))))
        Data$Variance[x] = signif(var(get(
          paste0(transform_name[j], "(", list[k], ")"))), 4)
        Data$Nonseasonal_Variance[x] = Data$Variance[x]
        Data$Seasonal_Variance[x] = Data$Variance[x]}
      if(list[k]==7 | list[k]==12){
        diff_name = append(diff_name, paste0(transform_name[j], "(", list[k], ")"))
        assign(paste0(transform_name[j], "(", list[k], ")"),  arima(
          transform[[j]], order = c(0,0,0), seasonal=list(
            order=c(0,1,0), period = list[k]), method="ML")$residuals)
        AICc = arima(
          transform[[j]], order = c(0,0,0), seasonal=list(
            order=c(0,1,0), period = list[k]), method="ML")
        Data$AICc[x] = try(AICc(AICc), silent = TRUE)
        Data[x,1] = paste0(transform_name[j], "(", list[k], ")")
        Data$Differencing[x] = paste0("Lag = none, Period = ", list[k])
        difference = append(difference, data.frame(get(
          paste0(transform_name[j], "(", list[k], ")"))))
        Data$Variance[x] = signif(var(get(
          paste0(transform_name[j], "(", list[k], ")"))), 4)
        Data$Seasonal_Variance[x] = Data$Variance[x]}
      if(list[k]==7){
        Data$Nonseasonal_Variance[x] = Data$Variance[x-2]}
      if(list[k]==12){
        Data$Nonseasonal_Variance[x] = Data$Variance[x-3]}
      if(list[k]==1.7){
        diff_name = append(diff_name, paste0(transform_name[j], "(", list[k], ")"))
        assign(paste0(transform_name[j], "(", list[k], ")"),  arima(
          transform[[j]], order = c(0,1,0), seasonal=list(
            order=c(0,1,0), period = 7), method="ML")$residuals)
       AICc = arima(
          transform[[j]], order = c(0,1,0), seasonal=list(
            order=c(0,1,0), period = 7), method="ML")
        Data$AICc[x] = try(AICc(AICc), silent = TRUE)
        Data[x,1] = paste0(transform_name[j], "(", list[k], ")")
        Data$Differencing[x] = "Lag = 1, Period = 7"
        difference = append(difference, data.frame(get(
          paste0(transform_name[j], "(", list[k], ")"))))
        Data$Variance[x] = signif(var(get(
          paste0(transform_name[j], "(", list[k], ")"))), 4)
        Data$Nonseasonal_Variance[x] = Data$Nonseasonal_Variance[x-3]
        Data$Seasonal_Variance[x] = Data$Seasonal_Variance[x-2]}
      if(list[k]==1.12){
        diff_name = append(diff_name, paste0(transform_name[j], "(", list[k], ")"))
        assign(paste0(transform_name[j], "(", list[k], ")"),  arima(
          transform[[j]], order = c(0,1,0), seasonal=list(
            order=c(0,1,0), period = 12), method="ML")$residuals)
        AICc = arima(transform[[j]], order = c(0,1,0), seasonal=list(
            order=c(0,1,0), period = 12), method="ML")
        Data$AICc[x] = try(AICc(AICc), silent = TRUE)
        Data[x,1] = paste0(transform_name[j], "(", list[k], ")")
        Data$Differencing[x] = "Lag = 1, Period = 12"
        difference = append(difference, data.frame(get(
          paste0(transform_name[j], "(", list[k], ")"))))
        Data$Nonseasonal_Variance[x] = Data$Nonseasonal_Variance[x-4]
        Data$Seasonal_Variance[x] = Data$Seasonal_Variance[x-2]
        Data$Variance[x] = signif(var(get(
          paste0(transform_name[j], "(", list[k], ")"))), 4)
        assign(paste0("diff_", transform_name[j]), difference)
        Difference = append(Difference, get(paste0("diff_", transform_name[j])))
        assign(paste0("diff_name_", transform_name[j]), diff_name)}
      
      ad_test <- append(ad_test, ad.test(difference[[k]]))
      Data[x, 6] = round(ad.test(difference[[k]])$p.value, digits=5)
      
      shapiro_test <- append(shapiro_test, shapiro.test(difference[[k]]))
      Data[x, 7] = round(shapiro.test(difference[[k]])$p.value, digits=5)
      
      adf_test <- append(adf_test, adf.test(difference[[k]]))
      Data[x, 8] = round(adf.test(difference[[k]])$p.value, digits=5)
      
      kpss_test <- append(kpss_test, kpss.test(difference[[k]]))
      Data[x, 9] = round(kpss.test(difference[[k]])$p.value, digits=5)
      
      Box_Pierce_test <- append(Box_Pierce_test, Box.test(
        difference[[k]], lag = sqrt(length(difference[[k]])), 
        type = c("Box-Pierce"), fitdf = 0))
      Data[x, 10] = round(Box.test(difference[[k]], lag=sqrt(length(
        difference[[k]])), type=c("Box-Pierce"), fitdf = 0)$p.value, digits=5)
      
      Ljung_Box_test <- append(Ljung_Box_test, Box.test(
        difference[[k]], lag=sqrt(length(difference[[k]])), type=c("Ljung-Box"), 
        fitdf = 0))
      Data[x, 11] = round(Box.test(difference[[k]], lag=sqrt(length(
        difference[[k]])), type=c("Ljung-Box"), fitdf = 0)$p.value, digits=5)
      
      McLeod_Li_test <- append(McLeod_Li_test, Box.test(
        (difference[[k]])^2, lag=sqrt(length(difference[[k]])), 
        type=c("Ljung-Box"), fitdf = 0))
      Data[x, 12] = round(Box.test((difference[[k]])^2, lag=sqrt(length(
        difference[[k]])), type=c("Ljung-Box"), fitdf = 0)$p.value, digits=5)
      
      Data$Pass[x]=0
      for(z in c(6,7, 9:12)){
        if(Data[x,z]>=0.05){
          Data$Pass[x] = 1 + Data$Pass[x]}}
      if(Data[x, 8] <= 0.05){
        Data$Pass[x] = 2 + Data$Pass[x]}
      Variance_Order = data.frame(matrix(ncol=3, nrow=5))
      colnames(Variance_Order) = c("Levels", "Variance", "Rank")
      Variance_Order$Levels = c("Original", "Transformation", "Differencing", 
                                "Seasonality", "Current")
      Variance_Order$Variance[1:5] = Data[x, c(13:17)]
      Variance_Order$Variance = as.double(Variance_Order$Variance)
      Variance_Order$Rank = as.integer(rank(Variance_Order$Variance, ties.method = "min"))
      Data$Variance_test[x] = paste0(
        Variance_Order$Rank[1], ", ", Variance_Order$Rank[2],
        ", ", Variance_Order$Rank[3], ", ", Variance_Order$Rank[4], ", ", 
        Variance_Order$Rank[5])
      Fails = 0
      if(Data[x, 13] < Data[x, 14]){
        Fails=Fails+1}
      if((Data[x, 14] < Data[x, 15]) & (Data[x, 14] < Data[x, 16])){
        Fails=Fails+1}
      if((Data[x, 13] < Data[x, 15]) & (Data[x, 13] < Data[x, 16])){
        Fails=Fails+1}
      if((Data[x, 15] < Data[x, 17]) & (Data[x, 16] < Data[x, 17])){
        Fails=Fails+1}
      if(Data[x, 13] < Data[x, 17]){
        Fails=Fails+1}
      if(Data[x, 14] < Data[x, 17]){
        Fails=Fails+1}
      Data$Pass[x] = (6-Fails)/6 + Data$Pass[x]
      if(Data$Pass[x] >= 5){
        # None of the undifferenced transformations for each data set are part of the best models
        if(list[k]==1){
          arima = arima(transform[[j]], order = c(0,1,0), method="ML")
          arima["Name"] = "ARIMA(0,1,0)"
          arima["x"] = x
          arima["i"] = i
          arima["j"] = transform_name[j]
          arima["pass"] = Data$Pass[x]
          Best_Models = append(Best_Models, list(arima))}
        if(list[k]==7){
          arima = arima(transform[[j]], order = c(0,7,0), method="ML")
          arima["Name"] = "SARIMA(0,0,0)x(0,1,0)_7"
          arima["x"] = x
          arima["i"] = i
          arima["j"] = transform_name[j]
          arima["pass"] = Data$Pass[x]
          Best_Models = append(Best_Models, list(arima))}
        if(list[k]==12){
          arima = arima(transform[[j]], order = c(0,12,0), method="ML")
          arima["Name"] = "SARIMA(0,0,0)x(0,1,0)_12"
          arima["x"] = x
          arima["i"] = i
          arima["j"] = transform_name[j]
          arima["pass"] = Data$Pass[x]
          Best_Models = append(Best_Models, list(arima))}
        if(list[k]==1.7){
          arima = arima(transform[[j]], order = c(0,1,0), seasonal=list(
            order=c(0,1,0), period = 7), method="ML")
          arima["Name"] = "SARIMA(0,1,0)x(0,1,0)_7"
          arima["x"] = x
          arima["i"] = i
          arima["j"] = transform_name[j]
          arima["pass"] = Data$Pass[x]
          Best_Models = append(Best_Models, list(arima))}
        if(list[k]==1.12){
          arima = arima(transform[[j]], order = c(0,1,0), seasonal=list(
            order=c(0,1,0), period = 12), method="ML")
          arima["Name"] = "SARIMA(0,1,0)x(0,1,0)_12"
          arima["x"] = x
          arima["i"] = i
          arima["j"] = transform_name[j]
          arima["pass"] = Data$Pass[x]
          Best_Models = append(Best_Models, list(arima))}}
      Pass1 = 0 
      for(s in 10:12){
        if(Data[x,s] >= 0.05){
          Pass1 = Pass1 + 1}}
      if(Pass1 == 3){
        Data$Residual_Tests[x] = "Pass"}
      else{
        Data$Residual_Tests[x] = "Fail"}
      Pass2 = 0
      if(Data[x,6] >= 0.05){
        Pass2 = Pass2 + 1}
      if(Data[x,7] >= 0.05){
        Pass2 = Pass2 + 1}
      if(Pass2 >= 1){
        Data$Normality_Tests[x] = "Pass"}
      else{
        Data$Normality_Tests[x] = "Fail"}
      Pass3 = 0
      if(Data[x,9] >= 0.05){
        Pass3 = Pass3 + 1}
      if(Data[x,8] <= 0.05){
        Pass3 = Pass3 + 1}
      if(Pass3 >= 1){
        Data$Stationarity_Tests[x] = "Pass"}
      else{
        Data$Stationarity_Tests[x] = "Fail"}
      x = x + 1}}}

Dict = dict(init_keys = NULL, init_values = NULL)
for(i in 1:480){
  Dict[Data$Name[i]] = Difference[[i]]}

Data["Dict"] = 1

Data1 = subset(Data, Data$Pass >= 5)
Data1
Stationarity = subset(Data, Data$Stationarity_Tests == "Pass")
Stationarity
Normality = subset(Data, Data$Normality_Tests == "Pass")
Normality
Residuals = subset(Data, Data$Residual_Tests == "Pass")
Residuals
```


```{r}
source("plot.roots.R")
Data2 <- subset(Data, Data$`Augmented Dickey-Fuller Test`<= 0.05 & Data$`KPSS Test` >= 0.05 & Data$`Anderson-Darling Test` >= 0.05 & Data$`Shapiro test` >= 0.05)

Data2_minAIC = subset(Data2, Data2$AICc == min(Data2$AICc))
Data2_minAIC$Name

x = auto.arima(`Cases2b.sqrt(1.7)`, start.p = 0, start.q = 0, d=1, D=1, start.P = 0, start.Q = 0, stationary=TRUE, seasonal = TRUE, allowmean=TRUE, trace = TRUE)

acvf = acf(Mortality.diff, plot=FALSE, lag.max = length(Mortality.diff))$acf[,1,1] * var(Mortality.diff) 
m = length(acvf)
lh.ia = innovations.algorithm(m+1, acvf)
lh.ia$thetas[9,1:9] # Preliminary estimates of coefficients for MA(9)
lh.ia$thetas[10,1:10] # Preliminary estimates of coefficients for MA(10)
lh.ia$thetas[11,1:11] # Preliminary estimates of coefficients for MA(11)
lh.ia$thetas[12,1:12]
x
da = subset(Data_a, Data_a$Pass == max(Data_a$Pass))

vect=vector()
vect=append(vect, 1)
vect=append(vect, 1)
vect=append(vect, 1)
vect=append(vect, 1)
vect=append(vect, 1)
vect1=vector()
vect1=append(vect1, 1)
vect1=append(vect1, 1)
vect1=append(vect1, 1)
vect1=append(vect1, 1)
vect1=append(vect1, 1)
vect=append(vect, vect1)
vect
y = arima(`Cases2b.sqrt(1.7)`,order=c(3,0,1), method="ML")
```

```{r}
plot_fn = function(name, arima){
  x=acf2(res, main=name)
  mtext(paste0("Shapiro: ", round(shapiro.test(res)$p.value, digits=3), "     McLeod-Li: ", round(Box.test((res)^2, lag=sqrt(length(res)), type=c("Ljung-Box"), fitdf = 0)$p.value, digits=3), "     ad.test: ", round(ad.test(res)$p.value, digits=3)), side=1, line=-6.5, adj=0, cex=0.7)
  mtext(paste0("Box-Pierce: ", round(Box.test(res, lag = sqrt(length(res)), type = c("Box-Pierce"), fitdf = 0)$p.value, digits=3), "     adf.test: ", round(adf.test(res)$p.value, digits=3), "     Ljung-Box: ", round(Box.test(res, lag=sqrt(length(res)), type=c("Ljung-Box"), fitdf = 0)$p.value, digits=3), "     kpss.test: ", round(kpss.test(res)$p.value, digits=3)), side=1, line=-5.5, adj=0, cex=0.7)
  op <- par("mfrow", "mar")
  par(mfrow = c(3, 2), mar = c(rep.int(2, 3), 0.5))
  res = arima$residuals
  require(TSA)
  plot.ts(res, main=name)
  abline(h=mean(res), col= "blue")
  abline(lm(res ~ as.numeric(1:length(res))), col="red")
  periodogram(res, log = 'yes', main=paste0(name, " Periodogram"), cex.main=0.6)
  periodogram(res, log = 'no', main=paste0(name, " Periodogram"), cex.main=0.6)
  abline(h=0)
  hist(res, col="light blue", xlab="", main=name, prob=TRUE)
  mtext(paste0("Variance = ", round(var(res), digits = 4)), side=1, line = 3, cex = 0.8)
  m <- mean(res)
  std <- sqrt(var(res))
  x = res
  curve( dnorm(x,m,std), add=TRUE)
  qqnorm(res,main= paste0(name, " Q-Q Plot"), cex.main=0.8)
  qqline(res,col="blue")
  cpgram(res, main=name)
  par(mfrow = op$mfrow, mar = op$mar)}

plot_fxn = function(name, res){
  x=acf2(res, main=name)
  mtext(paste0("Shapiro: ", round(shapiro.test(res)$p.value, digits=3), "     McLeod-Li: ", round(Box.test((res)^2, lag=sqrt(length(res)), type=c("Ljung-Box"), fitdf = 0)$p.value, digits=3), "     ad.test: ", round(ad.test(res)$p.value, digits=3)), side=1, line=-6.5, adj=0, cex=0.7)
  mtext(paste0("Box-Pierce: ", round(Box.test(res, lag = sqrt(length(res)), type = c("Box-Pierce"), fitdf = 0)$p.value, digits=3), "     adf.test: ", round(adf.test(res)$p.value, digits=3), "     Ljung-Box: ", round(Box.test(res, lag=sqrt(length(res)), type=c("Ljung-Box"), fitdf = 0)$p.value, digits=3), "     kpss.test: ", round(kpss.test(res)$p.value, digits=3)), side=1, line=-5.5, adj=0, cex=0.7)
  op <- par("mfrow", "mar")
  par(mfrow = c(3, 2), mar = c(rep.int(2, 3), 0.5))
  require(TSA)
  plot.ts(res, main=name)
  abline(h=mean(res), col= "blue")
  abline(lm(res ~ as.numeric(1:length(res))), col="red")
  periodogram(res, log = 'yes', main=paste0(name, " Periodogram"), cex.main=0.6)
  periodogram(res, log = 'no', main=paste0(name, " Periodogram"), cex.main=0.6)
  abline(h=0)
  hist(res, col="light blue", xlab="", main=name, prob=TRUE)
  mtext(paste0("Variance = ", round(var(res), digits = 4)), side=1, line = 3, cex = 0.8)
  m <- mean(res)
  std <- sqrt(var(res))
  x = res
  curve( dnorm(x,m,std), add=TRUE)
  source("plot.roots.R")
  qqnorm(res,main= paste0(name, " Q-Q Plot"), cex.main=0.8)
  qqline(res,col="blue")
  cpgram(res, main=name)
  par(mfrow = op$mfrow, mar = op$mar)}

ar(Residuals, aic = TRUE, order.max = NULL, method = c("yule-walker"))
ar(Residuals, aic = TRUE, order.max = NULL, method = c("mle"))


Residuals1 = rbind(Residuals, Residuals_a)

Dict.res = dict(init_keys = NULL, init_values = NULL)

for(t in 1:length(Residuals1$Name)){
  par(mfrow = c(3, 2), mar = c(rep.int(2, 3), 0.5))
  name = Residuals1$Name[t]
  if(Residuals1$Dict[t] == 1){
    res = Dict[name]}
  else{
    res = Dict1[name]}
  Dict.res[name] = res}

# Vax3b.log(1)
plot_fxn("Vax3b.log(1)", Dict.res["Vax3b.log(1)"])
arima1 = arima(Dict.res["Vax3b.log(1)"], order = c(1,0,0), method = "ML")
x = exp(arima1$residuals)
Residuals = arima1$residuals
plot_fn("Vax3b.log(1)(1,0,0)", arima1)
polyroot(c(1, arima1$coef[1:length(arima1$coef)-1]))
plot_fxn("Vax3b(1)(1,0,0)", x)
ar(Residuals, aic = TRUE, order.max = NULL, method = c("yule-walker"))
ar(Residuals, aic = TRUE, order.max = NULL, method = c("mle"))
arima1_1 = arima(Vax3b$Vax3b, order = c(1,1,0), method="ML")
plot_fn("Vax3b(1,1,0)", arima1_1)

# Best = "Vax3b(1,1,0)"

--------------------------------------------------------------------
# Vax3b.log(1.7)
plot_fxn("Vax3b.log(1.7)", Dict.res["Vax3b.log(1.7)"])
arima2 = arima(Dict.res["Vax3b.log(1.7)"], order = c(1,0,0), method = "ML")
x = exp(arima2$residuals)
Residuals = arima2$residuals
plot_fn("Vax3b.log(1.7)(1,0,0)", arima2)
polyroot(c(1, arima2$coef[1:length(arima2$coef)-1]))
plot_fxn("Vax3b(1.7)(1,0,0)", x)
ar(Residuals, aic = TRUE, order.max = NULL, method = c("yule-walker"))
ar(Residuals, aic = TRUE, order.max = NULL, method = c("mle"))
arima2_1 = arima(Vax3b$Vax3b, order = c(1,1,0), seasonal = list(order=c(0,1,0), period= 7), method = "ML")
plot_fn("Vax3b(1,1,0)(0,1,0)_7", arima2_1)

# Best = "Vax3b(1,1,0)(0,1,0)_7"

-------------------------------------------------------------------------


# Vax3b.log(1.12)
plot_fxn("Vax3b.log(1.12)", Dict.res["Vax3b.log(1.12)"])
arima3 = arima(Dict.res["Vax3b.log(1.12)"], order = c(1,0,0), method = "ML")
x = exp(arima3$residuals)
Residuals = arima3$residuals
plot_fn("Vax3b.log(1.12)(1,0,0)", arima3)
polyroot(c(1, arima3$coef[1:length(arima3$coef)-1]))
plot_fxn("Vax3b(1.12)(1,0,0)", x)
ar(Residuals, aic = TRUE, order.max = NULL, method = c("yule-walker"))
ar(Residuals, aic = TRUE, order.max = NULL, method = c("mle"))
arima3_1 = arima(Vax3b$Vax3b, order = c(1,1,0), seasonal = list(order=c(0,1,0), period= 12), method = "ML")
plot_fn("Vax3b(1,1,0)(0,1,0)_12", arima3_1)

# Best = "Vax3b(1,1,0)(0,1,0)_12"

------------------------------------------------------------------------
  
# Vax3b.log1(1)
plot_fxn("Vax3b.log1(1)", Dict.res["Vax3b.log1(1)"])
arima1 = arima(Dict.res["Vax3b.log1(1)"], order = c(1,0,0), method = "ML")
x = exp(arima1$residuals)
Residuals = arima1$residuals
plot_fn("Vax3b.log1(1)(1,0,0)", arima1)
polyroot(c(1, arima1$coef[1:length(arima1$coef)-1]))
plot_fxn("Vax3b(1)(1,0,0)", x)
ar(Residuals, aic = TRUE, order.max = NULL, method = c("yule-walker"))
ar(Residuals, aic = TRUE, order.max = NULL, method = c("mle"))

--------------------------------------------------------------------
# Vax3b.log1(1.7)
plot_fxn("Vax3b.log1(1.7)", Dict.res["Vax3b.log1(1.7)"])
arima2 = arima(Dict.res["Vax3b.log1(1.7)"], order = c(1,0,0), method = "ML")
x = exp(arima2$residuals)
Residuals = arima2$residuals
plot_fn("Vax3b.log1(1.7)(1,0,0)", arima2)
polyroot(c(1, arima2$coef[1:length(arima2$coef)-1]))
plot_fxn("Vax3b(1.7)(1,0,0)", x)
ar(Residuals, aic = TRUE, order.max = NULL, method = c("yule-walker"))
ar(Residuals, aic = TRUE, order.max = NULL, method = c("mle"))

-------------------------------------------------------------------------


# Vax3b.log1(1.12)
plot_fxn("Vax3b.log1(1.12)", Dict.res["Vax3b.log1(1.12)"])
arima3 = arima(Dict.res["Vax3b.log1(1.12)"], order = c(1,0,0), method = "ML")
x = exp(arima3$residuals)
Residuals = arima3$residuals
plot_fn("Vax3b.log1(1.12)(1,0,0)", arima3)
polyroot(c(1, arima3$coef[1:length(arima3$coef)-1]))
plot_fxn("Vax3b1(1.12)(1,0,0)", x)
ar(Residuals, aic = TRUE, order.max = NULL, method = c("yule-walker"))
ar(Residuals, aic = TRUE, order.max = NULL, method = c("mle"))

------------------------------------------------------------------------

# Mort2b1(1.7)
plot_fxn("Mort2b1(1.7)", Dict.res["Mort2b1(1.7)"])
Residuals = Dict.res["Mort2b1(1.7)"]
plot_fn("Mort2b1(1.7)", arima3)
ar(Residuals, aic = TRUE, order.max = NULL, method = c("yule-walker"))
ar(Residuals, aic = TRUE, order.max = NULL, method = c("mle"))
arima3_1 = arima(Mort2b$Mort2b, order = c(1,1,0), seasonal = list(order=c(0,1,0), period= 7), method = "ML")
plot_fn("Mort2b(0,1,0)(0,1,0)_7", arima3_1)  


arima2 = arima(exp(Dict.res["Vax3b.log(1.7)"]), order = c(1,0,0), method = "ML")
x = exp(arima2$residuals)
plot_fn("Vax3b.log(1.7)(1,0,1)", arima2)
ar_fn(arima2$residuals)
plot(arima2)
plot(polyroot(c(1, 0.2444459)))
polyroot(arima1$coef)

```


# Plot, Box-Cox, Histogram, Periodogram, QQ-Plot, ACF/PACF
# V1
```{r, warning=FALSE}

for(t in 1:length(Residuals1$Name)){
  op <- par("mfrow", "mar")
  par(mfrow = c(3, 2), mar = c(rep.int(2, 3), 0.5))
  name = Residuals1$Name[t]
  if(Residuals1$Dict[t] == 1){
    res = Dict[name]}
  else{
    res = Dict1[name]}
  for(s in 1:length(res)){
    if(is.na(res)){
      res[s] = (res[s-1] + res[s+1])/2}}
  
  require(TSA)
  plot.ts(res, main=name)
  abline(h=mean(res), col= "blue")
  abline(lm(res ~ as.numeric(1:length(res))), col="red")
  periodogram(res, log = 'yes', main=paste0(name, " Periodogram"), cex.main=0.6)
  periodogram(res, log = 'no', main=paste0(name, " Periodogram"), cex.main=0.6)
  abline(h=0)
  hist(res, col="light blue", xlab="", main=name, prob=TRUE)
  mtext(paste0("Variance = ", round(var(res), digits = 4)), side=1, line = 3, cex = 0.8)
  m <- mean(res)
  std <- sqrt(var(res))
  x = res
  curve( dnorm(x,m,std), add=TRUE)
  qqnorm(res,main= paste0(name, " Q-Q Plot"), cex.main=0.8)
  qqline(res,col="blue")
  cpgram(res, main=name)
  par(mfrow = op$mfrow, mar = op$mar)
  x=acf2(res, main=name)
  mtext(paste0("Shapiro: ", round(shapiro.test(res)$p.value, digits=3), "     McLeod-Li: ", round(Box.test((res)^2, lag=sqrt(length(res)), type=c("Ljung-Box"), fitdf = 0)$p.value, digits=3), "     ad.test: ", round(ad.test(res)$p.value, digits=3)), side=1, line=-6.5, adj=0, cex=0.7)
  mtext(paste0("Box-Pierce: ", round(Box.test(res, lag = sqrt(length(res)), type = c("Box-Pierce"), fitdf = 0)$p.value, digits=3), "     adf.test: ", round(adf.test(res)$p.value, digits=3), "     Ljung-Box: ", round(Box.test(res, lag=sqrt(length(res)), type=c("Ljung-Box"), fitdf = 0)$p.value, digits=3), "     kpss.test: ", round(kpss.test(res)$p.value, digits=3)), side=1, line=-5.5, adj=0, cex=0.7)}
```

# Plot, Box-Cox, Histogram, Periodogram, QQ-Plot, ACF/PACF
# V2
```{r, warning=FALSE}


for(t in 1:length(Best_Models_a)){
  op <- par("mfrow", "mar")
  par(mfrow = c(3, 2), mar = c(rep.int(2, 3), 0.5))
  res = Best_Models_a[[t]]
  res = 
  z = 4* (t-1) +1
  zzz = 4*t-1
  zzzz=4*t
  Dict1$keys[Residuals$X[t]+2]
  name = paste0(Best_Models_a1[zzzz], "(", Best_Models_a1[z], ")")
  i = Best_Models_a1[[zzz]]
  j = Best_Models_a1[[zzzz]]
  if(j %in% bc){
    bcTransform <- boxcox(vect[[i]] ~ as.numeric(1:length(vect[[i]])))
    bcTransform$x[which(bcTransform$y == max(bcTransform$y))]
    lambda=bcTransform$x[which(bcTransform$y == max(bcTransform$y))]
    title(main = paste0(vect1[i], "  lambda = ", round(lambda, 3)))}
  require(TSA)
  plot.ts(res, main=name)
  abline(h=mean(res), col= "blue")
  abline(lm(res ~ as.numeric(1:length(res))), col="red")
  periodogram(res, log = 'yes', main=paste0(name, " Periodogram"), cex.main=0.6)
  periodogram(res, log = 'no', main=paste0(name, " Periodogram"), cex.main=0.6)
  abline(h=0)
  hist(res, col="light blue", xlab="", main=name, prob=TRUE)
  mtext(paste0("Variance = ", round(var(res), digits = 4)), side=1, line = 3, cex = 0.8)
  m <- mean(res)
  x = res
  std <- sqrt(var(res))
  curve( dnorm(x,m,std), add=TRUE)
  qqnorm(res,main= paste0(name, " Q-Q Plot"), cex.main=0.8)
  qqline(res,col="blue")
  cpgram(res, main=name)
  par(mfrow = op$mfrow, mar = op$mar)
  x=acf2(res, main=name)
  mtext(paste0("Shapiro: ", round(shapiro.test(res)$p.value, digits=3), "     McLeod-Li: ", round(Box.test((res)^2, lag=sqrt(length(res)), type=c("Ljung-Box"), fitdf = 0)$p.value, digits=3), "     ad.test: ", round(ad.test(res)$p.value, digits=3)), side=1, line=-7.5, adj=0, cex=0.7)
    mtext(paste0("Box-Pierce: ", round(Box.test(res, lag = sqrt(length(res)), type = c("Box-Pierce"), fitdf = 0)$p.value, digits=3), "     adf.test: ", round(adf.test(res)$p.value, digits=3), "     Ljung-Box: ", round(Box.test(res, lag=sqrt(length(res)), type=c("Ljung-Box"), fitdf = 0)$p.value, digits=3), "     kpss.test: ", round(kpss.test(res)$p.value, digits=3)), side=1, line=-6.5, adj=0, cex=0.7)}

```


```{r}
x
Data = data.frame(matrix(nrow=972, ncol=2))
colnames(Data) = c("Model", "AICc")

loop.s = c(12)
loop.p = c(0,1,2,3,4,5,12,15)
loop.d = c(0,1)
loop.q = c(0,1,2,3,4,5,12,15)
loop.P = c(0,1)
loop.Q = c(0,1)
loop.D = c(0)

i = 1
for(s in loop.s){
  for(D in loop.D){
    for(Q in loop.Q){
      for(P in loop.P){
        for(d in loop.d){
          for(q in loop.q){
            for(p in loop.p){
                Data[i, 1] = paste0("SARIMA(", p, ",", d+1, ",", q, ")x(", P, ",", D, ",", Q, ")_", s)
                assign(paste0("SARIMA(", p, ",", d+1, ",", q, ")x(", P, ",", D, ",", Q, ")_", s), 
                       try(arima(Best_Models_a[[12]], order=c(p,d,q), seasonal=list(order=c(P,D,Q), period=s), method="ML")))
                Data[i, 2] = try(AIC(get(paste0("SARIMA(", p, ",", d+1, ",", q, ")x(", P, ",", D, ",", Q, ")_", s))))
                x=try(acf2(get(paste0("SARIMA(", p, ",", d+1, ",", q, ")x(", P, ",", D, ",", Q, ")_", s))$residuals, 
                       main = paste0("SARIMA(", p, ",", d+1, ",", q, ")x(", P, ",", D, ",", Q, ")_", s, "  AICc = ", Data[i,2])))
                }
              }}}}}}

```



```{r}
Data_aa = data.frame(matrix(nrow=10000, ncol=3))
colnames(Data_aa) = c("Model", "AICc", "Pass")

i = 1
for(x in 1:length(Best_Models_a)){
  min = vector()
  if(ar(Best_Models_a[[1]], aic = TRUE, order.max = NULL, method = c("yule-walker"))$order > 0){
    min = append(min, ar(Best_Models_a[[1]], aic = TRUE, order.max = NULL, method = c("yule-walker"))$order)}
  if(ar(Best_Models_a[[1]], aic = TRUE, order.max = NULL, method = c("mle"))$order > 0){
    min = append(min, ar(Best_Models_a[[1]], aic = TRUE, order.max = NULL, method = c("mle"))$order)}
  if(ar(Best_Models_a[[1]], aic = TRUE, order.max = NULL, method = c("ols"))$order > 0){
    min = append(min, ar(Best_Models_a[[1]], aic = TRUE, order.max = NULL, method = c("ols"))$order)}
  if(ar(Best_Models_a[[1]], aic = FALSE, order.max = NULL, method = c("yule-walker"))$order > 0){
    min = append(min, ar(Best_Models_a[[1]], aic = FALSE, order.max = NULL, method = c("yule-walker"))$order)}
  if(ar(Best_Models_a[[1]], aic = FALSE, order.max = NULL, method = c("mle"))$order > 0){
    min = append(min, ar(Best_Models_a[[1]], aic = FALSE, order.max = NULL, method = c("mle"))$order)}
  if(ar(Best_Models_a[[1]], aic = FALSE, order.max = NULL, method = c("ols"))$order > 0){
    min = append(min, ar(Best_Models_a[[1]], aic = FALSE, order.max = NULL, method = c("ols"))$order)}
  min1 = sort(min)[1]

  num = 4 * (x-1) + 2
  Set = 4 * (x-1) + 3
  name = Best_Models_a1[[Set]]
  Name = vect1[name]
  number = Best_Models_a1[[num]]
  if(Data_a$Differencing[[number]] == "Lag = 1 & Lag = 7"){
    s = 7
    d = 1
    D = 1}
  if(Data_a$Differencing[[number]] == "Lag = 1 & Lag = 12"){
    s = 12
    d = 1
    D = 1}
  if(Data_a$Differencing[[number]] == "Lag = 1"){
    s = 0
    d = 1
    D = 0}
  if(Data_a$Differencing[[number]] == "Lag = 7"){
    s = 7
    d = 0
    D = 1}
  if(Data_a$Differencing[[number]] == "Lag = 12"){
    s = 12
    d = 0
    D = 1}
  
  if(min >= 4){
    loop.p = c(0,1,2,min1-1,min1)
    loop.q = c(0,1,2,min1-1,min1)}
  else{
    loop.p = c(seq(0,5))
    loop.q = c(seq(0,5))}

  loop.P = c(0,1,2)
  loop.Q = c(0,1,2)
  
  for(Q in loop.Q){
    for(P in loop.P){
      for(q in loop.q){
        for(p in loop.p){
          print(paste0(i, ".", x))
          Data_aa[i, 1] = paste0("SARIMA(", p, ",", d, ",", q, ")x(", P, ",", D, ",", Q, ")_", s)
          assign(paste0("SARIMA(", p, ",", d, ",", q, ")x(", P, ",", D, ",", Q, ")_", s), 
                 try(arima(Best_Models_a[[x]], order=c(p,d,q), seasonal=list(
                   order=c(P,D,Q), period=s), method="ML")))
          Data_aa[i, 2] = try(AIC(get(paste0("SARIMA(", p, ",", d, ",", q, ")x(", P, ",", D, ",", Q, ")_", s))))
          res = try(get(paste0("SARIMA(", p, ",", d, ",", q, ")x(", P, ",", D, ",", Q, ")_", s))$residuals)
          Data_aa$Pass[i] = 0
          if(try(round(ad.test(difference[[k]])$p.value, digits=5) >= 0.05) |
             try(round(shapiro.test(difference[[k]])$p.value, digits=5) >= 0.05)){
            Data_aa$Pass[i] = Data_aa$Pass[i] + 1}
          if(try(round(adf.test(difference[[k]])$p.value, digits=5) <= 0.05) |
             try(round(kpss.test(difference[[k]])$p.value, digits=5) >= 0.05)){
            Data_aa$Pass[i] = Data_aa$Pass[i] + 1}
          if(try(round(Box.test(difference[[k]], lag=sqrt(length(
            difference[[k]])), type=c("Box-Pierce"), fitdf = 0)$p.value, digits=5) >= 0.05)){
            Data_aa$Pass[i] = Data_aa$Pass[i] + 1}
          if(try(round(Box.test(difference[[k]], lag=sqrt(length(
            difference[[k]])), type=c("Ljung-Box"), fitdf = 0)$p.value, digits=5) >= 0.05)){
            Data_aa$Pass[i] = Data_aa$Pass[i] + 1}
          if(try(round(Box.test((difference[[k]])^2, lag=sqrt(length(
            difference[[k]])), type=c("Ljung-Box"), fitdf = 0)$p.value, digits=5) >= 0.05)){
            Data_aa$Pass[i] = Data_aa$Pass[i] + 1}
          if(Data_aa$Pass[i] >= 3){
            z=try(acf2(res, main = paste0(Name, "SARIMA(", p, ",", d, ",", q, ")x(", P, ",", D, ",", Q, ")_", s, "  AICc = ", Data_aa[i,2]), cex=0.8))
            try(mtext(paste0("Shapiro: ", round(shapiro.test(res)$p.value, digits=3), 
                             "     McLeod-Li: ", round(Box.test((res)^2, lag=sqrt(length(res)), type=c("Ljung-Box"), 
                                                                fitdf = 0)$p.value, digits=3),
                             "     ad.test: ", round(ad.test(res)$p.value, digits=3)), 
                      side=3, line=-9, adj=0, cex=0.7))
            try(mtext(paste0("Box-Pierce: ", round(Box.test(res, lag = sqrt(length(res)), type = c("Box-Pierce"), 
                                                            fitdf = 0)$p.value, digits=3), 
                             "     adf.test: ", round(adf.test(res)$p.value, digits=3), 
                             "     Ljung-Box: ", round(Box.test(res, lag=sqrt(length(res)), type=c("Ljung-Box"), 
                                                            fitdf = 0)$p.value, digits=3), 
                             "     kpss.test: ", round(kpss.test(res)$p.value, digits=3)), 
                      side=3, line=-10, adj=0, cex=0.7))}
                i=i+1}}}}}

```




```{r}
source('plot.roots.R')

read_file('plot.roots.R')
plot.roots(`SARIMA(5,1,5)x(1,0,1)_7`)
`SARIMA(5,1,5)x(1,0,1)_7`
`SARIMA(5,1,5)x(1,0,1)_7(fixed)` = arima(Mortality, order = c(5,1,5), seasonal=list(order=c(1,0,1), period=7), method="ML", fixed = c(0,0,0,0,0,0,0,0,0,0,0,NA))
acf2(`SARIMA(5,1,5)x(1,0,1)_7(fixed)`$residuals)    

`SARIMA(5,1,4)x(0,0,1)_7(fixed)` = arima(Mortality, order=c(5,1,4), seasonal=list(order=c(0,0,1), period=7), method="ML", fixed= c(0, NA, NA, NA, NA, NA, NA, NA, NA, NA))

acf(`SARIMA(5,1,4)x(0,0,1)_7(fixed)`$residuals)
mtext("hello",  side=1, srt=-90, line=2, h.just=2)
`SARIMA(5,1,5)x(0,0,2)_7`

`SARIMA(5,1,5)x(0,0,2)_7(fixed)` = arima(Mortality, order=c(5,1,5), seasonal=list(order=c(0,0,2), period=7), method="ML", fixed= c(0, NA, NA, NA, NA, NA, NA, 0, NA, NA, NA, NA))
acf2(`SARIMA(5,1,5)x(0,0,2)_7(fixed)`$residuals)
x=Box.test(`SARIMA(4,1,4)x(2,0,1)_7`$residuals, lag=40, type=c("Box-Pierce"), fitdf = 11)
x$p.value
`SARIMA(3,1,2)x(1,0,1)_7`
kpss.test(`SARIMA(4,1,4)x(2,0,1)_7`$residuals)
check.statio
acf2(`SARIMA(3,1,2)x(2,0,1)_7`$residuals)

`SARIMA(3,1,2)x(1,0,1)_7(fixed)` = arima(Mortality, order=c(3,1,2), seasonal=list(order=c(1,0,1), period=7), method="ML", fixed= c(NA, 0, NA, NA, NA, 0, NA))
acf2(`SARIMA(3,1,2)x(1,0,1)_7(fixed)`$residuals)
adf
kpss.test(`SARIMA(4,1,4)x(2,0,1)_7`$residuals)
autoplot(`SARIMA(4,1,4)x(2,0,1)_7`$residuals)
plot(`SARIMA(4,1,4)x(2,0,1)_7`$root)

`SARIMA(3,1,2)x(1,0,1)_7(fixed)` = arima(Mortality, order=c(3,1,2), seasonal=list(order=c(1,0,1), period=7), method="ML", fixed= c(NA, 0, NA, NA, NA, 0, NA))
acf2(`SARIMA(3,1,2)x(1,0,1)_7(fixed)`$residuals)

acf2(arima(Mortality, order = c(5,1,5), seasonal=list(order=c(1,0,1), period=7), method="ML")$residuals)



acf2(`SARIMA(4,1,4)x(2,0,1)_7`$residuals)
mtext(paste0("Box-Pierce: p-value = ", signif(Box.test(`SARIMA(4,1,4)x(2,0,1)_7`$residuals, lag=sqrt(1228), type=c("Box-Pierce"), fitdf = 11)$p.value, digits=3), "________________________________Ljung-Box: p-value = ", signif(Box.test(`SARIMA(4,1,4)x(2,0,1)_7`$residuals, lag=sqrt(1228), type=c("Ljung-Box"), fitdf = 11)$p.value, digits=3)),  side=1, line=-6, adj=0, cex=.8)
mtext(paste0("McLeod-Li: p-value = ", signif(Box.test((`SARIMA(4,1,4)x(2,0,1)_7`$residuals)^2, lag=sqrt(1228), type=c("Ljung-Box"), fitdf = 11)$p.value, digits=3), "_________________________________Shapiro: p-value = ", signif(shapiro.test(`SARIMA(4,1,4)x(2,0,1)_7`$residuals)$p.value, digits=3)),  side=1, line=-7, adj=0, cex=.8)


```


```{r}
Data = data.frame(matrix(nrow=972, ncol=2))
colnames(Data) = c("Model", "AICc")

loop.s = c(7)
loop.p = c(0,1,2,3,4,5)
loop.d = c(1)
loop.q = c(0,1,2,3,4,5)
loop.P = c(0,1,2)
loop.Q = c(0,1,2)
loop.D = c(0,1,2)

i = 1
for(s in loop.s){
  for(D in loop.D){
    for(Q in loop.Q){
      for(P in loop.P){
        for(d in loop.d){
          for(q in loop.q){
            for(p in loop.p){
              if((p==3 & d==1 & q==2 & P==1 & Q==1 & D==0) | (p==5 & d==1 & q==5 & P==1 & Q==1 & D==0) | (p==3 & d==1 & q==2 & P==2 & Q==1 & D==0) | (p==1 & d==1 & q==3 & P==2 & Q==1 & D==0) | (p==4 & d==1 & q==4 & P==2 & Q==1 & D==0)){
                Data[i, 1] = paste0("SARIMA(", p, ",", d, ",", q, ")x(", P, ",", D, ",", Q, ")_", s)
                assign(paste0("SARIMA(", p, ",", d, ",", q, ")x(", P, ",", D, ",", Q, ")_", s), 
                       arima(Mortality2a, order=c(p,d,q), seasonal=list(order=c(P,D,Q), period=s)))
                Data[i, 2] = AIC(get(paste0("SARIMA(", p, ",", d, ",", q, ")x(", P, ",", D, ",", Q, ")_", s)))
                x=acf2(get(paste0("SARIMA(", p, ",", d, ",", q, ")x(", P, ",", D, ",", Q, ")_", s))$residuals, 
                       main = paste0("SARIMA(", p, ",", d, ",", q, ")x(", P, ",", D, ",", Q, ")_", s, "  AICc = ", Data[i,2]))}
              else{
                if(P==0 & Q==0 & D==0){
                  Data[i, 1] = paste0("ARIMA(", p, ",", d, ",", q, ")")}
                else{
                  Data[i, 1] = paste0("SARIMA(", p, ",", d, ",", q, ")x(", P, ",", D, ",", Q, ")_", s)}
                assign(paste0("SARIMA(", p, ",", d, ",", q, ")x(", P, ",", D, ",", Q, ")_", s), 
                       arima(Mortality, order=c(p,d,q), seasonal=list(order=c(P,D,Q), period=s), method="ML"))
                Data[i, 2] = AIC(get(paste0("SARIMA(", p, ",", d, ",", q, ")x(", P, ",", D, ",", Q, ")_", s)))
                x=acf2(get(paste0("SARIMA(", p, ",", d, ",", q, ")x(", P, ",", D, ",", Q, ")_", s))$residuals, 
                       main = paste0("SARIMA(", p, ",", d, ",", q, ")x(", P, ",", D, ",", Q, ")_", s, "  AICc = ", Data[i,2]))
              i=i+1}}}}}}}}
                  

```



```{r}     
          acf2(assign(paste0("SARIMA(", p, "_1_", q, ")x(0,1,0)_", s), arima(Mortality_1, order=c(p,0,q), seasonal=list(order=c(0,1,0), period=s), method="ML"))$residuals, main = paste0("SARIMA(", p, "_1_", q, ")x(0,1,0)_", s))}
        else{
          acf2(assign(paste0("SARIMA(", p, "_1_", q, ")x(0,1,0)_", s), arima(Mortality, order=c(p,1,q), seasonal=list(order=c(0,1,0), period=s), method="ML"))$residuals, main = paste0("SARIMA(", p, "_1_", q, ")x(0,1,0)_", s))}}}}}
x=arima(Mortality)
plot(x)
      
    assign(paste0("ARIMA1_", p, "_1_", q), arima(Mortality_1, order=c(p,1,q), seasonal=list(order=c(0,1,0), period=12), method="ML"))
    acf2(assign(paste0("Residuals_ARIMA_0_1_", i,  "_of_", x), arima(Mortality, order=c(0,1,i), method="ML")$residuals), main = paste0("ARIMA_0_1_", i, " of ", x))
    variable1 = paste0("ARIMA_0_1_", i)
    variable2 = paste0("Residuals_ARIMA0_1_", i,  "_of_", x)
}}

```

```{r}

  arima(Mortality, order=c(1,1,1), seasonal = list(order = c(0,1,1), period = 0), method="ML")
  acf2(x
# Model
Model1 = arima(Mortality.stat, order=c(0,1,1), seasonal = list(order = c(0,1,1), period = 12), method="ML")

Model1

x = acf2(Model1)

AICc(Model1)



x=residuals(covid["new_cases_smoothed"])


x

arima(Mortality, order=c(4,1,5), seasonal = list(order = c(1,0,1), period = 7), method = "ML")

AICc(arima(Mortality, order=c(0,1,3), seasonal = list(order = c(0,1,1), period = 12), method="ML"));
[1] -441.0091
arima(Mortality, order=c(0,1,3), seasonal = list(order = c(0,1,1), period = 12), fixed = c(NA, 0, NA, NA),
method="ML")
ma1 ma2 ma3 sma1 -0.3353 0 -0.1612 -0.5782
s.e. 0.0810 0 0.0852 0.0796
sigma^2 estimated as 0.00127: log likelihood = 225.38, aic = -442.76
AICc(arima(Mortality, order=c(0,1,3), seasonal = list(order = c(0,1,1), period = 12), fixed = c(NA, 0, NA, NA), method="ML")) [1] -442.4489
32
polyroot(c(1, 0.87, 0.76))
  • To check invertibility of MA part of model A:
source("plot.roots.R")
plot.roots(NULL,polyroot(c(1, -0.3353, 0, -0.1612)), main="(A) roots of ma part, nonseasonal ")
• Diagnostic checking of model B:
fit <- arima(Mortality, order=c(0,1,1), seasonal = list(order = c(0,1,1), period = 12), method="ML")
res <- residuals(fit)
hist(res,density=20,breaks=20, col="blue", xlab="", prob=TRUE)
m <- mean(res)
std <- sqrt(var(res))
curve( dnorm(x,m,std), add=TRUE )
plot.ts(res)
fitt <- lm(res ~ as.numeric(1:length(res))); abline(fitt, col="red")
abline(h=mean(res), col="blue")
qqnorm(res,main= "Normal Q-Q Plot for Model B")
qqline(res,col="blue"
acf(res, lag.max=40)
pacf(res, lag.max=40)
shapiro.test(res)
Box.test(res, lag = 12, type = c("Box-Pierce"), fitdf = 2) Box.test(res, lag = 12, type = c("Ljung-Box"), fitdf = 2)
Box.test(res^2, lag = 12, type = c("Ljung-Box"), fitdf = 0)
acf(res^2, lag.max=40)
ar(res, aic = TRUE, order.max = NULL, method = c("yule-walker"))

• Forecasting using model A:
install.packages("forecast")
library(forecast)
fit.A <- arima(Mortality, order=c(0,1,3), seasonal = list(order = c(0,1,1), period = 12),
fixed = c(NA, 0, NA, NA), method="ML")
forecast(fit.A) % prints forecasts with prediction bounds in a table
• To produce graph with 12 forecasts on transformed data:
pred.tr <- predict(fit.A, n.ahead = 12)
U.tr= pred.tr$pred + 2*pred.tr$se % upper bound of prediction interval L.tr= pred.tr$pred - 2*pred.tr$se % lower bound
ts.plot(Mortality, xlim=c(1,length(Mortality)+12), ylim = c(min(Mortality),max(U.tr)))
lines(U.tr, col="blue", lty="dashed")
lines(L.tr, col="blue", lty="dashed")
points((length(Mortality)+1):(length(Mortality)+12), pred.tr$pred, col="red")
34

  • To produce graph with forecasts on original data:
pred.orig <- exp(pred.tr$pred)
U= exp(U.tr)
L= exp(L.tr)
ts.plot(Mortality, xlim=c(1,length(Mortality)+12), ylim = c(min(Mortality),max(U))) lines(U, col="blue", lty="dashed")
lines(L, col="blue", lty="dashed")
points((length(Mortality)+1):(length(Mortality)+12), pred.orig, col="red")
• To zoom the graph, starting from entry 100:
ts.plot(Mortality, xlim = c(100,length(Mortality)+12), ylim = c(250,max(U))) lines(U, col="blue", lty="dashed")
lines(L, col="blue", lty="dashed")
points((length(Mortality)+1):(length(Mortality)+12), pred.orig, col="red")
• To plot zoomed forecasts and true values (in Mortality):
ts.plot(Mortality, xlim = c(100,length(Mortality)+12), ylim = c(250,max(U)), col="red") lines(U, col="blue", lty="dashed")
lines(L, col="blue", lty="dashed")
points((length(Mortality)+1):(length(Mortality)+12), pred.orig, col="green")
points((length(Mortality)+1):(length(Mortality)+12), pred.orig, col="black")


```

```{r}



```

```{r}



```

```{r}



```


```{r}
Mortality.diff7 = diff(Mortality, lag=7, differences=2)
Mortality.diff8 = diff(Mortality.diff7, 1)
plot.ts(Mortality.diff)
Mortality.diff_acf1
acf2(Mortality.diff7)

acf2(Mortality.diff8)
var(Mortality.diff)

Mortality.diff2 = diff(Mortality, 2)
plot.ts(Mortality.diff2)
Mortality_acf2 = acf2(Mortality.diff2)
var(Mortality.diff2)

Mortality.diff3 = diff(Mortality, 3)
plot.ts(Mortality.diff3)
Mortality_acf3 = acf2(Mortality.diff3)
var(Mortality.diff3)

Mortality.diff4 = diff(Mortality, 4)
plot.ts(Mortality.diff4)
Mortality_acf4 = acf2(Mortality.diff4)
var(Mortality.diff4)
adf.test
# Diff = 1
var(Mortality.diff) < var(Mortality.diff2)

ar1 = ar(Mortality.diff, aic = FALSE, method="mle") # 12
ar2 = ar(Mortality.diff, aic = FALSE, method="yw") # 29
ar3 = ar(Mortality.diff, aic = TRUE, method="mle") # 10
ar4 = ar(Mortality.diff, aic = TRUE, order.max = 12, method="yw") # 10

source("innovations.R")

acvf = acf(Mortality.diff, plot=FALSE, lag.max = length(Mortality.diff))$acf[,1,1] * var(Mortality.diff) 
m = length(acvf)
lh.ia = innovations.algorithm(m+1, acvf)
lh.ia$thetas[9,1:9] # Preliminary estimates of coefficients for MA(9)
lh.ia$thetas[10,1:10] # Preliminary estimates of coefficients for MA(10)
lh.ia$thetas[11,1:11] # Preliminary estimates of coefficients for MA(11)
lh.ia$thetas[12,1:12] # Preliminary estimates of coefficients for MA(12)

arima1 <- auto.arima(Mortality, start.p = 0, start.q = 0, d=1, start.P = 0, start.Q = 0, stationary=TRUE, seasonal = TRUE, allowmean=TRUE, trace = TRUE) # 5,0,0

fit.ar1 <- arima(Mortality.diff8, order=c(1,1,7), seasonal=list(order=c(6,2,2), period=7))

fit.ar1.1 <- arima(Mortality.diff8, order=c(1,1,7), seasonal=list(order=c(4,2,2), period=7), fixed=c(NA,NA,NA,0,0,NA,NA,NA,NA,NA,NA,NA,NA,NA))

a=acf2(fit.ar1.1$residuals)
acf2(fit.ar1$residuals)
a
fit.ar1
fit.ar2 <- arima(Mortality.diff8, order=c(7,1,7), seasonal=list(order=c(6,2,1), period=7))
acf2(fit.ar2$residuals)

fit.ar2 <- arima(Mortality.diff, order=c(0,0,0))

acf1 = acf2(fit.ar1$residuals)
acf1

fit.ar2 <- arima(Mortality, order=c(8,1,1))
fit.ar2 
acf2 = acf2(fit.ar2$residuals)
acf1 = acf2(fit.ar1$residuals)

fit.sarima = astsa::sarima(Mortality,8,1,1,0,1,0,7, model=TRUE)
acf2(fit.sarima$fit$residuals)

fit.ar3.1
fit.ar3.2

fit.ar3.1 <- arima(Mortality, transform.pars = TRUE, method="ML", order=c(0,1,10), seasonal=list(order=c(0,1,1), period=14), include.mean=TRUE, fixed=c(NA,NA,NA,NA,NA,NA,NA,NA,0,NA,NA))

fit.ar3.2 <- arima(Mortality, transform.pars = TRUE, method="ML", order=c(0,1,10), seasonal=list(order=c(0,1,1), period=14), include.mean=TRUE)
acf2(fit.ar3.1$residuals)

acf2(fit.ar3.2$residuals)
                 
fit.ar3 <- arima(Mortality, order=c(0,1,15), seasonal=list(order=c(0,1,1), period=14), fixed=c(NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,0,0,0,0,0,NA), a)

fit.ar4 <- arima(Mortality, order=c(0,1,7), seasonal=list(order=c(0,1,1), period=14))

fit.ar5 <- arima(Mortality, order=c(5,1,10), seasonal=list(order=c(0,1,1), period=14))
fit.ar5
acf5


fit.ar5.1 <- arima(Mortality, order=c(5,1,), seasonal=list(order=c(0,1,1), period=14), fixed = c(0,NA,0,0,NA,0,0,0,0,0,0,NA,NA))

fit.ar5.1
fit.ar5
plot(fit.ar5)
acf3 = acf2(fit.ar3$residuals)
acf3.1 = acf2(fit.ar3.1$residuals)
acf4 = acf2(fit.ar4$residuals)
acf5.1 = acf2(fit.ar5.1$residuals)
acf5 = acf2(fit.ar5$residuals, plot=FALSE)
acf5
fit.ar5
Mortality.diff_acf1 = acf2(Mortality.diff)


fit.ar2 <- arima(Mortality.diff, order=c(10,0,0))
fit.ar3 <- arima(Mortality.diff, order=c(12,0,0))
fit.ar4 <- arima(Mortality.diff, order=c(29,0,0))

fit.ma5 <- arima(Mortality.diff, order=c(0,0,9))
fit.ma6 <- arima(Mortality.diff, order=c(0,0,10))
fit.ma7 <- arima(Mortality.diff, order=c(0,0,11))
fit.ma8 <- arima(Mortality.diff, order=c(0,0,12))

fit.arma9 <- arima(Mortality.diff, order=c(5,0,9)) # 12/14 0.05 < s.e. < 0.21
fit.arma10 <- arima(Mortality.diff, order=c(5,0,10)) # NAN produced
fit.arma11 <- arima(Mortality.diff, order=c(5,0,11)) # all 0.07 < s.e. < 0.77
fit.arma12 <- arima(Mortality.diff, order=c(5,0,12)) # 13/17 0.05 < s.e. < 0.837

fit.arma13 <- arima(Mortality.diff, order=c(10,0,9)) # NAN produced
fit.arma14 <- arima(Mortality.diff, order=c(10,0,10)) # 18/20  0.05 < s.e. < 0.099
fit.arma15 <- arima(Mortality.diff, order=c(10,0,11)) # all 0.97 < s.e. < 0.32
fit.arma16 <- arima(Mortality.diff, order=c(10,0,12)) # all 0.12 < s.e. < 0.61

fit.arma17 <- arima(Mortality.diff, order=c(12,0,9)) # all 0.05 < s.e. < 0.60
fit.arma18 <- arima(Mortality.diff, order=c(12,0,10)) # NAN produced
fit.arma19 <- arima(Mortality.diff, order=c(12,0,11)) # NAN produced
#fit.arma20 <- arima(Mortality.diff, order=c(12,0,12)) # all 0.09 < s.e. < 0.37
#fit.arma21 <- arima(Mortality.diff, order=c(29,0,9)) # NAN produced
#fit.arma22 <- arima(Mortality.diff, order=c(29,0,10)) # NAN produced
# fit.arma23 <- arima(Mortality.diff, order=c(29,0,11)) # NAN produced
# fit.arma24 <- arima(Mortality.diff, order=c(29,0,12)) # NAN produced

# STATIONARY
fit.arma25_10 <- arima(Mortality.diff, order=c(25,0,10)) # NAN produced
# STATIONARY w/out NANs for s.e. 
fit.arma25_9 <- arima(Mortality.diff, order=c(25,0,9)) # NAN produced

Data <- data.frame(c(AICc(fit.ar1),
AICc(fit.ar2),
AICc(fit.ar3),
AICc(fit.ar4),
AICc(fit.ma5),
AICc(fit.ma6),
AICc(fit.ma7),
AICc(fit.ma8),
AICc(fit.arma9),
AICc(fit.arma10),
AICc(fit.arma11),
AICc(fit.arma12),
AICc(fit.arma13),
AICc(fit.arma14),
AICc(fit.arma15),
AICc(fit.arma16),
AICc(fit.arma17),
AICc(fit.arma18),
AICc(fit.arma19),
#AICc(fit.arma20),
#AICc(fit.arma21),
#AICc(fit.arma22),
AICc(fit.arma25_10),
AICc(fit.arma25_9)))

rownames(Data) <- c("AR(5)", "AR(10)", "AR(12)", "AR(29)", "MA(9)", "MA(10)", "MA(11)", "MA(12)", "ARMA(5,9)", "ARMA(5,10)", "ARMA(5,11)", "ARMA(5,12)", "ARMA(10,9)", "ARMA(10,10)", "ARMA(10,11)", "ARMA(10,12)", "ARMA(12,9)", "ARMA(12,10)", "ARMA(12,11)", "ARMA(25,10)", "ARMA(25,9)")
colnames(Data) <- c("AICc")

Data["Lowest AICc"] <- as.integer(rank(Data$AICc))
Data

acf1 = acf2(fit.ar1$residuals)
acf2 = acf2(fit.ar2$residuals)
acf3 = acf2(fit.ar3$residuals)
acf4 = acf2(fit.ar4$residuals)
acf5 = acf2(fit.ma5$residuals)
acf6 = acf2(fit.ma6$residuals)
acf7 = acf2(fit.ma7$residuals)
acf8 = acf2(fit.ma8$residuals)
acf9 = acf2(fit.arma9$residuals)
acf10 = acf2(fit.arma10$residuals)
acf11 = acf2(fit.arma11$residuals)
acf12 = acf2(fit.arma12$residuals)
acf13 = acf2(fit.arma13$residuals)
acf14 = acf2(fit.arma14$residuals)
acf15 = acf2(fit.arma15$residuals)
acf16 = acf2(fit.arma16$residuals)
acf17 = acf2(fit.arma17$residuals)
acf18 = acf2(fit.arma18$residuals)
acf19 = acf2(fit.arma19$residuals)
#acf20 = acf2(fit.arma20$residuals)
#acf21 = acf2(fit.arma21$residuals)
#acf22 = acf2(fit.arma22$residuals)
acf23 = acf2(fit.arma25_10$residuals)
acf24 = acf2(fit.arma25_9$residuals)

```
